<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>C·ªù Caro Gi·∫£i tr√≠</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        .cell.last {
            background: #90caf9 !important;
            box-shadow: 0 0 8px #42a5f5;
            animation: pulse 0.8s ease-in-out;
        }
        @keyframes pulse {
            from { transform: scale(1); }
            to { transform: scale(1.1); }
        }

        /* G·ªôp n√∫t Trang ch·ªß (d√πng chung cho c·∫£ khi ƒëang ch∆°i v√† sau khi k·∫øt th√∫c) */
        #home-btn {
            background: rgba(255,255,255,0.9);
            color: #333;
            border: none;
            border-radius: 10px;
            padding: 8px 18px;
            font-size: 16px;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 12px;
        }
        #home-btn:hover {
            background: #ffe082;
            transform: scale(1.05);
        }

        #timer {
            font-size: 18px;
            font-weight: 600;
            color: #ffeb3b;
            margin-top: 6px;
        }
    </style>
</head>
<body>
    <h1>C·ªù Caro 16√ó16</h1>

    <div id="menu">
        <button id="find">T√¨m ƒë·ªëi th·ªß</button>
        <button id="solo">Ch∆°i 1 m√¨nh (ƒë·∫•u m√°y)</button>
        <p id="status">Ch∆∞a k·∫øt n·ªëi</p>
    </div>

    <div id="game-area" style="display:none;">
        <p id="turn-status"></p>
        <p id="timer"></p>
        <div id="board"></div>

        <div id="after-game" style="margin-top: 15px; display: none;">
            <button id="play-again">üîÑ Ch∆°i l·∫°i</button>
        </div>

        <!-- ‚úÖ N√∫t Trang ch·ªß duy nh·∫•t, d√πng chung -->
        <button id="home-btn">üè† Trang ch·ªß</button>
    </div>

    <script>
        const socket = io();
        let mySymbol = null, roomId = null, myTurn = false, soloMode = false;
        const BOARD_N = 16;

        const boardEl = document.getElementById('board');
        const statusEl = document.getElementById('status');
        const menu = document.getElementById('menu');
        const gameArea = document.getElementById('game-area');
        const turnStatus = document.getElementById('turn-status');
        const afterGame = document.getElementById('after-game');
        const timerEl = document.getElementById('timer');
        const homeBtn = document.getElementById('home-btn');

        let timerInterval = null;
        let timeLeft = 30;

        function createEmptyBoard() {
            return Array.from({ length: BOARD_N }, () => Array(BOARD_N).fill(''));
        }

        function drawBoard(board, winner_positions = [], last = null) {
            boardEl.innerHTML = '';
            const winSet = new Set(winner_positions.map(p => p[0] + ',' + p[1]));
            for (let i = 0; i < BOARD_N; i++) {
                for (let j = 0; j < BOARD_N; j++) {
                    const div = document.createElement('div');
                    div.classList.add('cell');
                    if (winSet.has(i + ',' + j)) div.classList.add('win');
                    if (last && last[0] === i && last[1] === j) div.classList.add('last');
                    div.textContent = board[i][j];
                    if (board[i][j] === 'X') div.style.color = '#e53935';
                    if (board[i][j] === 'O') div.style.color = '#1e88e5';
                    div.onclick = () => {
                        if (myTurn && board[i][j] === '')
                            socket.emit('make_move', { room: roomId, row: i, col: j });
                    };
                    boardEl.appendChild(div);
                }
            }
        }

        function startTimer() {
            clearInterval(timerInterval);
            timeLeft = 30;
            updateTimer();
            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimer();
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    myTurn = false;
                    turnStatus.textContent = "‚è∞ H·∫øt gi·ªù! B·∫°n ƒë√£ thua!";
                    socket.emit('timeout', { room: roomId });
                }
            }, 1000);
        }

        function stopTimer() { clearInterval(timerInterval); }

        function updateTimer() {
            timerEl.textContent = myTurn ? `‚è± C√≤n l·∫°i: ${timeLeft}s` : '';
        }

        socket.on('connected', () => {
            statusEl.textContent = '‚úÖ K·∫øt n·ªëi th√†nh c√¥ng. Ch·ªçn ch·∫ø ƒë·ªô ƒë·ªÉ b·∫Øt ƒë·∫ßu!';
        });

        document.getElementById('find').onclick = () => {
            soloMode = false;
            socket.emit('find_room', { solo: false });
        };
        document.getElementById('solo').onclick = () => {
            soloMode = true;
            socket.emit('find_room', { solo: true });
        };

        socket.on('waiting', data => statusEl.textContent = data.msg);

        socket.on('room_joined', data => {
            roomId = data.room;
            mySymbol = data.symbol;
            menu.style.display = 'none';
            gameArea.style.display = 'block';
            afterGame.style.display = 'none';
            statusEl.textContent = `üéÆ ƒê√£ v√†o ph√≤ng ${roomId}. B·∫°n l√† ${mySymbol}`;
        });

        socket.on('start_game', data => {
            myTurn = (data.turn === mySymbol);
            afterGame.style.display = 'none';
            drawBoard(createEmptyBoard());
            stopTimer();
            if (myTurn) startTimer();
            turnStatus.textContent = myTurn ? "üü¢ ƒê·∫øn l∆∞·ª£t b·∫°n!" : "üïê Ch·ªù ƒë·ªëi th·ªß...";
        });

        socket.on('state_update', data => {
            const { board, finished, winner, winner_positions = [], turn } = data;
            drawBoard(board, winner_positions);
            if (finished) {
                stopTimer();
                afterGame.style.display = 'block';
                timerEl.textContent = '';
                if (winner === 'draw') turnStatus.textContent = "üòê H√≤a!";
                else if (winner === mySymbol) turnStatus.textContent = "üéâ B·∫°n th·∫Øng!";
                else if (winner === 'O' && soloMode) turnStatus.textContent = "ü§ñ M√°y th·∫Øng!";
                else turnStatus.textContent = "üò≠ B·∫°n thua!";
            } else {
                myTurn = (turn === mySymbol);
                stopTimer();
                if (myTurn) startTimer();
                turnStatus.textContent = myTurn ? "üü¢ ƒê·∫øn l∆∞·ª£t b·∫°n!" : "üïê Ch·ªù ƒë·ªëi th·ªß...";
            }
        });

        document.getElementById('play-again').onclick = () => {
            stopTimer();
            socket.emit('find_room', { solo: soloMode });
            afterGame.style.display = 'none';
        };

        homeBtn.onclick = () => {
            if (confirm("‚ö†Ô∏è B·∫°n c√≥ ch·∫Øc mu·ªën tho√°t v·ªÅ Trang ch·ªß kh√¥ng?")) {
                stopTimer();
                menu.style.display = 'block';
                gameArea.style.display = 'none';
                afterGame.style.display = 'none';
                mySymbol = null; roomId = null; myTurn = false;
                boardEl.innerHTML = ''; timerEl.textContent = '';
                turnStatus.textContent = '';
                statusEl.textContent = 'üè† ƒê√£ quay l·∫°i menu ch√≠nh.';
            }
        };
    </script>
</body>
</html>
